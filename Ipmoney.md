# Ipmoney 专利交易小程序需求文档（优化补充版）

> 目标：让搜索列表的默认排序更贴近用户兴趣与区域产业特色；同时保持可控、可解释、可调参。
> 本文在现有需求基础上补充：业务边界、关键流程、检索字段规范、专利类型定义标准（发明/实用新型/外观设计）等。

## 0. 术语与范围（补充）

- **平台定位：** 居间/撮合服务，不直接替代专利权属转移的法定流程（过户/备案仍需按主管部门要求办理）。
- **品牌与视觉：** 前端主色建议为**橙色**（寓意成功/成交）；平台理念为“**专利点金台**”（把专利价值转化为可交易、可量化的收益）。
- **多端形态：** P0 支持 **微信小程序（买家/卖家） + 用户 H5（Taro；电脑端可用） + PC Web 管理后台（运营/客服/财务）**。
  - **电脑端 H5（P0）：** 支持浏览/搜索/详情/收藏/咨询；**下单与支付引导回小程序**（二维码/链接），避免 H5 支付/合规与渠道成本。
- **交易对象：** 专利交易为主；新增**书画专区**（书画作品交易，走订金+尾款）；产学研需求/成果为展示与咨询。
- **交易方式：** 专利以转让为主、许可为辅（P0 支持许可：独占/排他/普通；前台默认转让）；书画专区以**直接交易**为主（拍卖/委托为 P1）。
- **沉睡专利：** 转让次数为 0 的专利（`transferCount=0`），卡片标签展示“沉睡专利”。
- **高新退役专利：** 高新技术企业曾经使用过、已退役/闲置的优质专利；**由企业提交材料，平台审核通过后标记**（非仅凭转让次数判断）。
- **产业集群特色专利：** 以**产业集群**为核心维度组织的专题专利集合；以 `clusterId` 独立字段标识（与行政区 `regionCode` 解耦）。
- **开放许可：** 交易方式为**许可**的专利（`tradeMode=LICENSE`），用于“开放许可”专题入口。
- **专利公告：** 公告/挂牌清单等（如“广东工业大学专利开发许可清单(202601)”），支持列表+详情（**不提供附件功能**）。
- **订金：** 用于表达交易意向并触发客服介入；是否可退、退还条件、违约责任必须在协议与流程中明确。
- **上架信息来源：** 用户发布为主（P0 以用户上传/后台录入为准）；P1 可选接入官方/第三方检索源做自动回填与校验（减少手填、降低造假），书画专区同理走外部适配层。
- **数据地图/大数据分析（P1 预留）：** 数据地图包含专利地图（发明/实用新型/外观设计）+书画成果地图+技术经理人地图/科学家地图；大数据分析包含**交易库/成果库/产学研库**，先预留架构与后台入口。

## 1. 角色与权限（建议补充）

- **游客：** 可浏览公开信息与搜索；敏感字段（联系方式、证件等）默认不展示。
- **已注册未认证：** 可收藏/咨询；发布与支付前需完成实名认证/主体认证。
- **身份/主体认证（P0）：**
  - **个人：** 可直接授权信息完成注册（无需后台审核）；发布/交易前如需更严格实名可作为 P1 追加。
  - **企业：** 提交主体信息与材料，后台审核通过后可发布/交易；**通过后可在小程序“机构展示”中被检索/展示**。
  - **科研院校：** 提交主体信息与材料，后台审核通过后可发布/交易；**通过后可在小程序“机构展示”中被检索/展示**。
  - **政府：** 提交主体信息与材料，后台审核通过后可发布/交易（是否在前台展示可配置）。
  - **行业协会/学会：** 提交主体信息与材料，后台审核通过后可发布/交易（是否在前台展示可配置）。
  - **技术经理人：** 提交个人资质信息与材料，后台审核通过后可发布/交易（可作为“服务方/撮合方”展示）。
- **平台运营：** 内容审核、用户认证审核、类目/标签/敏感词配置。
- **客服：** 跟单、聊天监管、线下流程记录、发起退款/争议处理流转。
- **财务：** 对账、退款、佣金结算、发票。

### 1.1 后台 RBAC 权限矩阵（P0 默认，可配置）

> 说明：以下为 **P0 默认角色权限**（可在后台配置/扩展）；所有“审核/退款/放款/配置修改”等关键操作必须记录审计日志（见 6.3/ER）。

| 功能/操作（权限点） | 运营 | 客服 | 财务 | 管理员 |
|---|---|---|---|---|
| 用户与认证：查看/审核（`verification.read/review`） | 查看/审核 | 查看 | 查看 | 全部 |
| 上架：查看/审核（`listing.read/audit`） | 查看/审核 | 查看 | - | 全部 |
| 订单：查看（`order.read`） | 查看 | 查看 | 查看 | 全部 |
| 工单：创建/分配/跟进（`case.manage`） | 查看/分配 | 创建/跟进 | 查看 | 全部 |
| 里程碑：合同签署确认（`milestone.contractSigned.confirm`） | - | 操作 | - | 全部 |
| 里程碑：变更完成确认（`milestone.transferCompleted.confirm`） | - | 操作 | - | 全部 |
| 退款：买家申请处理（`refund.read/approve/reject`） | 审批 | 发起/建议 | 审批/执行 | 全部 |
| 结算：台账查看（`settlement.read`） | 查看 | 查看 | 查看 | 全部 |
| 放款：人工放款确认（`payout.manual.confirm`） | - | - | 操作 | 全部 |
| 发票：上传/下载电子发票（`invoice.manage`） | 查看 | - | 操作 | 全部 |
| 系统配置：交易规则/类目/敏感词（`config.manage`） | 操作 | - | - | 全部 |
| 报表/对账：查看/导出（`report.read/export`） | 查看/导出 | - | 查看/导出 | 全部 |
| 审计日志：查看（`auditLog.read`） | 查看 | 查看 | 查看 | 全部 |

## 2. 核心业务流程（端到端补充）

1. **卖家认证 → 发布专利/书画商品 → 平台审核 → 上架**
2. **买家搜索/筛选 → 在线咨询 → 支付订金 → 系统分配客服**
3. **客服介入：** 资料核验/尽调清单 → 线下签约（转让/许可合同）→ 权属变更/备案（如适用）
4. **尾款与结算：** 线下合同签署确认 → 线上支付尾款（平台托管）→ 权属变更完成 → 结算佣金并放款 → 订单完成/归档
5. **退款/争议：** 按“可退/不可退”规则、证据上传、客服/运营处理

## 3. 检索功能与专利类型分类标准（用于搜索/筛选）

### 3.1 三种专利类型的法定定义（《专利法》第二条）

- **发明：** 对产品、方法或者其改进所提出的新的技术方案。
- **实用新型：** 对产品的形状、构造或者其结合所提出的适于实用的新的技术方案。
- **外观设计：** 对产品的整体或者局部的形状、图案或者其结合以及色彩与形状、图案的结合所作出的富有美感并适于工业应用的新设计。

### 3.2 存续期提示（《专利法》第四十二条）

- **发明：** 20 年；**实用新型：** 10 年；**外观设计：** 15 年（均自申请日起算）。

### 3.3 检索字段规范（建议最小集合）

- **关键标识：** 专利号/申请号/公开号（支持多格式输入，统一规范化存储）。
- **专利类型：** 发明/实用新型/外观设计（必填，支持自动识别后可改）。
- **分类号：** 发明/实用新型用 IPC；外观设计用 Locarno（LOC）分类（用于“行业/领域”精细筛选）。
- **法律状态：** 申请中、已授权、终止/失效、无效（以数据源为准）。
- **权利人/申请人、发明人/设计人、申请日、公开/公告日**。
- **交易字段：** 交易方式（转让/许可）、标价/面议、订金、地区、行业标签、转让次数、发布时间、更新时间。

### 3.4 类型自动识别（可选增强）

- **若输入为公开号/公告号：** 末尾常见标记 A/B → 发明，U → 实用新型，S → 外观设计（以各国文献种类代码为准，存在例外需人工确认）。
- **若输入为中国申请号：** 常见格式 `YYYYTxxxxxxx.x`，其中 `T` 通常为 1/2/3 分别对应发明/实用新型/外观设计（PCT 等特殊号段需额外规则）。

### 3.5 参考来源（联网查询）

- WIPO Lex：《Patent Law of the People's Republic of China》Article 2 / Article 42：<https://www.wipo.int/wipolex/en/legislation/details/21027>
- WIPO IPC：<https://www.wipo.int/en/web/classification-ipc>
- WIPO Locarno：<https://www.wipo.int/en/web/classification-locarno>
- WIPO Standard ST.13（申请号编号结构建议）：<https://www.wipo.int/documents/d/standards/docs-en-03-13-01.pdf>
- WIPO Standard ST.16（文献种类代码 Kind code）：<https://www.wipo.int/documents/d/standards/docs-en-03-16-01.pdf>

### 3.6 专利号输入正则与规范化规则（P0 必做）

> 目标：让搜索列表的默认排序更贴近用户兴趣与区域产业特色；同时保持可控、可解释、可调参。

#### 3.6.1 支持的输入类型（P0：CN）

- **中国申请号（Application No.）**
  - **较新常见格式：** `YYYYTXXXXXXX.C`（含点号）或 `YYYYTXXXXXXXC`（纯数字）
    - `YYYY`=申请年（4 位），`T`=类型位（`1`/`2`/`3`），`XXXXXXX`=流水号（7 位），`C`=校验/控制位（1 位数字）
    - 例：`2023113409720` / `202311340972.0`
  - **历史常见格式（兼容）：** `YYTXXXXX.C`（含点号）或 `YYTXXXXX C`（纯数字/含分隔符）
    - `YY`=申请年（2 位），`T`=类型位（`1`/`2`/`3`），`XXXXX`=流水号（常见 5 位），`C`=校验/控制位（1 位数字）
    - 例（示意）：`96123456.1`
- **中国专利号（Patent No.）**：常见写法为 `ZL` + 申请号（本质上仍以申请号为主键）。
  - 例：`ZL202311340972.0`
- **中国公开号/公告号（Publication No. / Grant No.）**：`CN` + 数字 + **文献种类代码（Kind code）**
  - 例：`CN114123456A`、`CN114123456B`、`CN214123456U`、`CN314123456S`（Kind code 也可能包含数字，如 `A1/A8` 等，按数据源为准）

#### 3.6.2 规范化存储（建议输出字段）

- `jurisdiction`：国家/地区代码（WIPO ST.3），P0 默认 `CN`
- `identifier_type`：`CN_APPLICATION` / `CN_PUBLICATION` / `CN_PATENT(ZL)`
- `application_no_norm`：去掉点号与前缀后的纯数字（CN 常见长度 9 或 13 位），如 `2023113409720`
- `application_no_display`：展示格式（默认在末位前插入点号），如 `202311340972.0`
- `publication_no_norm`：去空格、全大写，如 `CN114123456A8`
- `patent_type`：`INVENTION` / `UTILITY_MODEL` / `DESIGN`
- `kind_code`：如 `A`/`B`/`U`/`S`/`A1`/`A8`…
- `parse_status`：`OK` / `FORMAT_ERROR` / `AMBIGUOUS`

#### 3.6.3 规范化清洗流程（先清洗再匹配）

1. **trim**：去首尾空白
2. **统一字符集**：全角转半角（数字、字母、冒号、括号等）；字母转大写
3. **删除噪声前缀/标签**：如 `专利号`/`申请号`/`公开号`/`公告号`/`：` 等（保留核心内容）
4. **移除分隔符**：空格、`-`、`_`、中文顿号/逗号等；**保留点号 `.`**（用于识别申请号校验位）
5. **模式匹配**：按优先级尝试 `CN_APPLICATION` → `CN_PUBLICATION` → 其他（P1 扩展）
6. **二次规范化**：输出 `*_norm` 与 `*_display`，并填充 `patent_type/kind_code`

#### 3.6.4 正则规则（建议“宽松识别 + 严格校验分层”）

> 说明：小程序/前端建议用“宽松识别”提升容错；后端入库前再做“严格校验 + 外部数据源核验”。

- **CN 申请号/专利号（宽松识别，允许 CN/ZL 前缀、允许有无点号；兼容新旧格式）**

```regex
^(?:CN)?(?:ZL)?(?<year>19\\d{2}|20\\d{2})(?<type>[123])(?<serial>\\d{7})\\.?((?<check>\\d))$
```

```regex
^(?:CN)?(?:ZL)?(?<year>\\d{2})(?<type>[123])(?<serial>\\d{5})\\.?((?<check>\\d))$
```

- **CN 公开号/公告号（宽松识别，允许 7~9 位数字 + Kind code，Kind code 允许带 1 位数字）**

```regex
^(?:CN)?(?<number>\\d{7,9})(?<kind>[A-Z]\\d?)$
```

- **类型映射（CN）**
  - 申请号 `type=1/2/3` → `发明/实用新型/外观设计`
  - 公开号 `kind=U` → `实用新型`；`kind=S` → `外观设计`；`kind=A/B` 通常为 `发明`（以数据源为准）

#### 3.6.5 校验策略（P0/P1）

- **P0：** 仅做“结构校验”（位数、字符集、前缀、Kind code 形态）；不强制校验位计算，避免误判导致用户无法发布。
- **P1：** 若确定数据源（CNIPA/第三方）提供校验位算法或校验接口，可增加“校验位/权属一致性/法律状态一致性”校验，并对异常给出可解释提示（例如“号码格式正确但未能在数据源检索到”）。

### 3.7 书画专区分类与字段规范（联网调研）

> 目标：统一书画专区分类维度与发布字段，便于检索与后续对接外部检索源。

- **一级类目：** 书法 / 绘画（书画专区主入口）。
- **书法书体（常用五体）：** 楷书、行书、草书、隶书、篆书（以行业通行分类为准）。
- **国画题材（三大类）：** 人物画、山水画、花鸟画（可扩展“其他”）。
- **作品要素（P0 必填）：** 作品名称、创作日期、创作者、作品介绍、著作权登记证书编号、作品图片（≥1）。
- **作品要素（P0 可选）：** 尺寸/材质、书体/题材、地区、标价/面议、订金、权属材料附件。
- **外部检索口径（P1 可选）：** 以著作权登记证书编号 + 作品名称/作者为主，接入外部检索源后返回“登记信息摘要+来源链接”；P0 先走后台人工核验并记录结果。

参考来源（联网）：
- 中国书法五体：<https://zh.wikipedia.org/wiki/中国书法>
- 中国画三大类：<https://zh.wikipedia.org/wiki/中国画>
- 著作权登记机构信息（查询入口以实际可用为准）：<https://www.ccopyright.com.cn/>

## 4. 筛选字段枚举与数据库字段设计（建议）

### 4.1 筛选字段枚举（面向前端/UI 与 API）

> 建议所有枚举值在接口中使用稳定的英文 code，避免 UI 文案变更导致兼容问题。

| 字段 | 类型 | 枚举/格式 | 说明 |
|---|---|---|---|
| `q` | string | 任意 | 搜索关键词（专利号/申请号/公开号/标题/摘要/申请人等） |
| `qType` | enum | `AUTO`/`NUMBER`/`KEYWORD`/`APPLICANT`/`INVENTOR` | 搜索类型（`AUTO` 自动判断） |
| `patentType` | enum | `INVENTION`/`UTILITY_MODEL`/`DESIGN` | 三种专利类型 |
| `legalStatus` | enum | `PENDING`/`GRANTED`/`EXPIRED`/`INVALIDATED`/`UNKNOWN` | 供筛选的“归一化状态”（可从事件流映射） |
| `ipc` | string[] | IPC 代码数组 | 发明/实用新型过滤；支持主分类/全部分类 |
| `locarno` | string[] | Locarno(LOC) 代码数组 | 外观过滤；支持主类/子类 |
| `tradeMode` | enum | `ASSIGNMENT`/`LICENSE` | 转让/许可 |
| `listingTopic` | enum | `HIGH_TECH_RETIRED`/`CLUSTER_FEATURED` | 专利专题入口（用于特色专区筛选） |
| `clusterId` | string | `CLUSTER_*` | 产业集群标识（与行政区解耦） |
| `licenseMode` | enum | `EXCLUSIVE`/`SOLE`/`NON_EXCLUSIVE` | 许可方式（仅 `LICENSE` 时出现） |
| `priceType` | enum | `FIXED`/`NEGOTIABLE` | 一口价/面议 |
| `priceMin/priceMax` | number | >=0 | 总价区间（单位分/元统一） |
| `depositMin/depositMax` | number | >=0 | 订金区间 |
| `transferCountMin/transferCountMax` | number | >=0 | 转让次数区间（统计字段） |
| `regionCode` | string | 行政区划码 | 发布地区/标的地区（建议统一国家标准或高德 adcode） |
| `createdFrom/createdTo` | date | `YYYY-MM-DD` | 发布时间区间 |
| `sortBy` | enum | `RECOMMENDED`/`NEWEST`/`PRICE_ASC`/`PRICE_DESC` | 排序 |
| `page/pageSize` | number | 1.. | 分页 |

### 4.2 数据库字段设计（核心表，关系型数据库）

> 目标：让搜索列表的默认排序更贴近用户兴趣与区域产业特色；同时保持可控、可解释、可调参。

**A. 专利主数据（建议）**

- `patents`
  - `id`（PK）
  - `jurisdiction`（`CN`）
  - `application_no_norm`（唯一，建议与 `jurisdiction` 组成唯一键）
  - `application_no_display`
  - `patent_type`（`INVENTION/UTILITY_MODEL/DESIGN`）
  - `title`、`abstract`
  - `filing_date`、`publication_date`、`grant_date`（可空）
  - `legal_status`（归一化枚举）+ `legal_status_raw`（保留原始文本/代码）
  - `source_primary`（主数据来源：`USER/ADMIN/PROVIDER`）+ `source_updated_at`
  - `created_at`、`updated_at`
- `patent_identifiers`（一专利多号码）
  - `id`（PK）、`patent_id`（FK）
  - `id_type`（`APPLICATION/PATENT(ZL)/PUBLICATION`）
  - `id_value_norm`（唯一，便于反查）
  - `kind_code`（公开号/公告号才有）
  - `date`（公开/公告日等，可空）
- `patent_classifications`
  - `id`（PK）、`patent_id`（FK）
  - `system`（`IPC/LOC/CPC`…）、`code`、`is_main`（主分类标记）
- `patent_parties`
  - `id`（PK）、`patent_id`（FK）
  - `role`（`APPLICANT/INVENTOR/ASSIGNEE`）、`name`、`country_code`（可空）
- `patent_legal_events`（可选：事件流，用于生成法律状态）
  - `id`（PK）、`patent_id`（FK）
  - `event_date`、`event_code`、`event_text_raw`、`source`

**B. 上架商品（专利交易）**

- `listings`
  - `id`（PK）
  - `seller_user_id`（FK）
  - `patent_id`（FK，可空：P0 允许先发后补齐专利主数据）
  - `title`（可覆盖专利标题）、`summary`（卖点）
  - `trade_mode`（`ASSIGNMENT/LICENSE`）+ `license_mode`（可空）
  - `price_type`（`FIXED/NEGOTIABLE`）+ `price_amount`（可空）
  - `deposit_amount`
  - `region_code`
  - `industry_tags_json`（可空）
  - `listing_topics_json`（如 `HIGH_TECH_RETIRED/CLUSTER_FEATURED`）
  - `cluster_id`（产业集群 ID，可空）
  - `audit_status`（`PENDING/APPROVED/REJECTED`）
  - `status`（`DRAFT/ACTIVE/OFF_SHELF/SOLD`）
  - `created_at`、`updated_at`
- `files`（对象存储文件元数据）
  - `id`（PK）、`url`、`mime_type`、`size_bytes`
  - `owner_scope`（`LISTING/CASE/REFUND_REQUEST/USER`）、`owner_id`
  - `created_at`
- `listing_media`（图片/附件）
  - `id`、`listing_id`、`file_id`、`type`、`sort`
- `listing_audit_logs`
  - `id`、`listing_id`、`reviewer_id`、`action`、`reason`、`created_at`
- `audit_logs`（关键操作审计日志，跨域）
  - `id`、`actor_user_id`、`action`（如 `LISTING_APPROVE/REFUND_APPROVE/PAYOUT_CONFIRM/CONFIG_UPDATE`）
  - `target_type`、`target_id`（多态指向：`LISTING/ORDER/REFUND_REQUEST/SYSTEM_CONFIG`…）
  - `before_json`、`after_json`（JSON，记录修改前后）、`request_id`、`ip`、`user_agent`、`created_at`

**C. 订单与支付（订金/尾款）**

- `orders`
  - `id`（PK）、`listing_id`（FK）、`buyer_user_id`（FK）
  - `status`（`DEPOSIT_PENDING/DEPOSIT_PAID/WAIT_FINAL_PAYMENT/FINAL_PAID_ESCROW/READY_TO_SETTLE/COMPLETED/CANCELLED/REFUNDING/REFUNDED`）
  - `deal_amount`（成交总价，可空：合同签署确认后写入）
  - `deposit_amount`、`final_amount`（可空：合同签署确认后写入）、`commission_amount`（可空：结算时写入）
  - `assigned_cs_user_id`（跟单客服，可空）
  - `created_at`、`updated_at`
- `payments`
  - `id`、`order_id`、`pay_type`（`DEPOSIT/FINAL/REFUND/PAYOUT`）
  - `channel`（`WECHAT/ALIPAY`…）、`trade_no`、`amount`、`status`、`paid_at`

**C2. 退款/工单/结算（建议最小表）**

> 说明：P0 以“可追溯、可对账、可仲裁”为目标，至少需要退款申请、客服工单与结算台账 3 类数据承载。

- `refund_requests`
  - `id`、`order_id`
  - `reason_code`、`reason_text`（可空）
  - `status`（`PENDING/APPROVED/REJECTED/REFUNDING/REFUNDED`）
  - `created_at`、`updated_at`
- `cs_cases`（跟单/退款/争议）
  - `id`、`order_id`、`cs_user_id`
  - `type`（`FOLLOWUP/REFUND/DISPUTE`）、`status`
  - `created_at`、`updated_at`
- `cs_milestones`（里程碑+证据）
  - `id`、`case_id`
  - `name`（`CONTRACT_SIGNED/TRANSFER_SUBMITTED/TRANSFER_COMPLETED`）
  - `status`（`PENDING/DONE`）
  - `evidence_file_id`（可空）、`created_at`
- `settlements`（结算台账）
  - `id`、`order_id`
  - `gross_amount`（成交总额）、`commission_amount`、`payout_amount`
  - `payout_method`（`MANUAL`/`WECHAT`…，P0 默认 `MANUAL`）
  - `payout_status`（`PENDING/SUCCEEDED/FAILED`）
  - `payout_ref`（可空：银行流水号/转账单号等）、`payout_evidence_file_id`（可空）
  - `status`、`created_at`、`updated_at`

**C3. 系统配置（承载 8.4，可后台配置）**

- `system_configs`
  - `id`、`key`（唯一）、`value_type`（`INT/DECIMAL/STRING/JSON/BOOL`）、`value`
  - `scope`（`GLOBAL` 或 `TENANT` 预留）、`version`
  - `updated_by`、`created_at`、`updated_at`

**D. 检索性能与索引建议（关键）**

- `patents(jurisdiction, application_no_norm)` 唯一索引
- `patent_identifiers(id_value_norm)` 唯一索引（支持任意号码反查专利）
- `listings(status, audit_status, created_at)` 组合索引（列表页）
- 标题/摘要/申请人：建议接入全文检索（PostgreSQL FTS / Elasticsearch / OpenSearch）

## 5. 数据来源与录入方案（已确认：用户上传 + 后台录入/导入）

> 本期不接入 CNIPA/第三方检索接口：专利信息以“用户发布时上传/填写 + 后台补录/导入”为准，并通过审核与材料校验控制风险。

### 5.1 本期数据来源

1. **用户上传（主）**
   - 发布专利商品时：输入专利号/申请号/公开号（按 3.6 规范化）+ 填写交易信息 + 上传权属/授权材料。
   - 发布书画作品时：填写作品信息 + 著作权登记证书编号 + 图片/权属材料（按 3.7 规范化）。
2. **后台录入/导入（辅）**
   - 运营可后台创建 `patents` 主数据、创建/代发 `listings`，并支持 Excel 批量导入（用于“精选交易/平台招商内容”）。
   - 书画专区支持后台录入/批量导入作品信息，用于冷启动与精选展示。

### 5.2 数据质量与风控（取代“外部权威核验”）

- **结构校验：** 专利号码/书画字段格式与类型映射（3.6/3.7），字段必填校验。
- **材料校验：** 上架前必须上传权属/授权链路材料（7.3），审核通过后方可展示“可交易”。
- **重复与冒用：** 允许同一 `application_no_norm` 多卖家上架，但每条 listing 必须独立通过材料审核与风控（7.4）。
- **数据标识：** 专利/书画详情页展示“数据来源=用户上传/后台录入”与更新时间，避免用户误解为官方数据。

### 5.3 可选扩展（P1）：外部数据源接入

> 若后续需要“自动回填/法律状态自动刷新/权威核验”，再接入外部数据源，并通过适配层隔离差异。

1. **官方渠道（推荐）**：CNIPA 公共服务平台/数据服务（接口需签约授权）；书画专区可评估著作权登记机构公开检索或授权接口。
2. **第三方商业数据源**：incoPat、PatSnap、Questel/Orbit、Derwent 等（以采购与接口文档为准）；书画专区可评估艺术品/版权数据服务。
3. **公开网页抓取/非公开接口（不建议生产）**：稳定性与合规风险高。

### 5.4 统一适配层（Provider Adapter）（P1）

- 抽象接口（示例）：
  - `lookupByApplicationNo(appNo_norm) -> PatentSnapshot`
  - `lookupByPublicationNo(pubNo_norm) -> PatentSnapshot`
  - `search(q, filters, page) -> PatentSnapshot[]`
  - `getLegalEvents(appNo_norm) -> LegalEvent[]`
- `PatentSnapshot` 建议包含：号码集合、标题摘要、类型、分类号、当事人、关键日期、法律状态、来源与更新时间

### 5.5 合规与安全要点

- 使用任何第三方/官方数据前，确认：**授权范围、可展示字段、可缓存期限、商业用途限制**。
- API Key/密钥：后端托管、分环境、定期轮换；日志脱敏（不记录完整密钥与敏感个人信息）。
- 平台内上传的证据材料（证件/合同等）按隐私与商业秘密做访问控制与水印（6.3/6.4）。

## 6. ???????NFR????????????

> ??????????????????/?????? NFR ??????????????????

### 6.1 ??????????? + ?????

**??????????????????**

- **??/????** P95 ?? ? 800ms???????? 2s?????????????
- **????** P95 ?? ? 1.5s??????????
- **??/?????** ?????? P95 ? 1.2s???**??**?**???**?
- **???????** 10 ???????????? + ???????

**???????????????**

- ?????DAU??????????? QPS??????? QPS?
- ?????????????????????????????????

**?????P0 ?????**

- ???????TTL ??????????????????
- ????????? IP ??????????????????
- ????????????/?????????

```yaml
performance_targets:
  search_list:
    p95_cached_ms: 800
    p95_uncached_ms: 2000
    max_page_size: 50
  detail_page:
    p95_ms: 1500
  order_write:
    p95_ms: 1200
    idempotency_window_minutes: 30
```

### 6.2 ??????

**SLO/SLI ?????????**

- **????????/??/????** ????? ? 99.9%?
- **????????** ????? ? 99.5%?
- **RPO/RTO?** RPO ? 15 ???RTO ? 2 ???P0 ??????

**???????**

- ?????????????????????????????????
- ????? + ?????????? `orderId/listingId/userId` ?????

```yaml
disaster_recovery:
  database_backup:
    full_backup_schedule: "daily"
    incremental_backup_schedule: "hourly"
    rpo_minutes: 15
    rto_minutes: 120
  deployment:
    supports_gray_release: true
    supports_one_click_rollback: true
```

### 6.3 ?????????????

- **??????** ???? RBAC???/??/????????????????
- **?????** ???/??/????????????/??????? + ???
- **??????** ???????????????????????/?????
- **??????** ??? HTTPS??????????????/??????
- **?????** ????/??/?????????????????
- **?????** ??/????????????????????/????/??????

```json
{
  "auditLogSchema": {
    "requestId": "uuid",
    "actorUserId": "string",
    "action": "LISTING_APPROVE",
    "targetType": "LISTING",
    "targetId": "string",
    "result": "SUCCESS",
    "latencyMs": 123,
    "ipAddress": "string",
    "userAgent": "string",
    "createdAt": "2026-01-01T00:00:00.000Z"
  }
}
```

### 6.4 ???????

- **?????** ????? + ?? OCR/?????????????????????
- **???????** ??????????????????????????????????????
- **?????** ?????????????????????????????
- **?????** ????????????????????????????

### 6.5 ???????

- **??/??/???** ????????????????????????????? SLA?
- **?????** ?? ? ?? ? ???? ? ?? ??????
- **?????** ??????????????????????????

```yaml
observability_metrics:
  error_rate_threshold_percent: 1
  payment_callback_error_alert: true
  review_backlog_threshold: 100
  customer_service_sla_minutes: 30
```

### 6.6 ??????????????P0 ??????

**??????/????P0?**

1. ??????
2. ??????
3. ??????????????????????????????????
4. ?????????????????????????????????????
5. ??????????????????????????=????????????
6. ????????????????????/???????/??????????????
7. ?????????????????????????????????/?????
8. ????????????????/????/????
9. ?????????

**????/?????P0 ???**

- ??/??????????????????
- ???????????????????????????????
- ????????????????????????????????????????????????
- ???????????????????????
## 7. ????????????????????/???

> ???????????/?????????????????????????????????????????????????????

### 7.1 ??????????????????

**???????**

- ???????????????????????????
- ??????????????????????????

**???????????**

- ?????????????????????????????
- ????????/????????? 2000~20000??

**????????**

- **?????????????** ??????? X ??????????
- **????????????** ?????????????????????????
- **????????????????** ???????????????????????

**???????P0?**

- ??????????????????
- ?????????`REFUND_REQUESTED` ? `REFUND_APPROVED/REFUND_REJECTED` ? `REFUND_PAID`?

```yaml
refund_rules:
  refundable_window_minutes: 30
  refundable_requires_evidence: true
  non_refundable_after_contract_signed: true
  min_deposit_amount: 2000
  max_deposit_amount: 20000
```

### 7.2 ???????

**????????**

- ??????????????????????
- ???????????????????

**??????**

- ?? = ??? ? ????????????
- ?????????????????????????

**???????**

- ????????????????????????
- ?????P0 ????????P1 ????????

```yaml
settlement_rules:
  commission_rate_percent: 6
  commission_payer: SELLER
  rounding_mode: HALF_UP
  payout_requires_transfer_completed: true
  payout_mode: MANUAL
```

### 7.3 ????/???????????

**??????????????**

- ???????????/????/??????
- ????????????????/???/?????
- ?????????????????????

**??????????????**

- ??????????????????
- ????/?????
- ?????????/??????

**????**

- ??????????????????????????
- ????????? 2 ???????

```yaml
delivery_checklist:
  contract_items:
    - ownership_certificate
    - party_identity_documents
    - signed_contract
  transfer_items:
    - transfer_application
    - acceptance_receipt
    - completion_proof
  retention_days: 730
```

### 7.4 ???????????

**??????**

- ?????/???/??????????????????
- ????????????????????????

**?????????????**

- ?????????????????
- ?????????/????????????????????

**????**

- ????????????????????????
- ??????????????????

```yaml
duplicate_listing_rules:
  allow_relist_after_sold: true
  allow_relist_after_off_shelf: true
  allow_parallel_trade_modes: true
  require_audit_for_parallel_trade_modes: true
  violation_action: REJECT_AND_LOG
```
## 8. ????????? + ?????????????

### 8.1 ??????????

1. **?? MVP?P0???**?
   - ?????**P0 ?? CN ??**?
   - ?????**??????????P0 ?????**?
   - ?????**???????????????**?
2. **????????**???/?????/?????????? SLA????????
3. **????????**?**???? + ????/???????**???????????? P1 ???
4. **????????**?????????????????????????

### 8.2 ?????

- **??????C4 ???**?Context/Container/Component?? `docs/architecture/`??
- **?????**?????/??/???? `docs/architecture/`??
- **ER ?**?? `docs/architecture/er-diagram.mmd`?
- **API ???OpenAPI?**?? `docs/api/openapi.yaml`?
- **??????**??? P0 ???????????????????????

### 8.3 ??/??/ER/OpenAPI ???????????

- C4-Context?`docs/architecture/c4-context.mmd`
- C4-Container?????????`docs/architecture/c4-container.mmd`
- C4-Component?????????`docs/architecture/c4-component-order.mmd`
- ??-?????`docs/architecture/sequence-deposit-payment.mmd`
- ??-???`docs/architecture/sequence-refund.mmd`
- ??-?????`docs/architecture/sequence-settlement.mmd`
- ????-?????`docs/architecture/flow-listing-publish.mmd`
- ????-??????`docs/architecture/flow-trade-end2end.mmd`
- ????-??/???`docs/architecture/flow-refund-dispute.mmd`
- ???-???`docs/architecture/state-order.mmd`
- ER ??`docs/architecture/er-diagram.mmd`
- OpenAPI?`docs/api/openapi.yaml`

### 8.4 P0 ???????????

> ?????? **P0 ???**?????????????????????????????????????/??????????????????

- **?????**
  - `deposit_rate_percent = 5`
  - `deposit_min_amount = 2000`
  - `deposit_max_amount = 20000`
  - `refundable_window_minutes = 30`
  - `refund_requires_evidence = true`
- **?????**
  - `commission_rate_percent = 6`
  - `commission_payer = SELLER`
  - `rounding_mode = HALF_UP`
  - `payout_requires_transfer_completed = true`
  - `payout_mode = MANUAL`
- **???????**
  - `listing_review_sla_hours = 24`
  - `require_reject_reason = true`
  - `duplicate_listing_policy = REJECT_AND_LOG`
- **?????**
  - `first_response_sla_minutes = 30`
  - `conversation_retention_days = 365`

```yaml
p0_default_config:
  deposit_config:
    deposit_rate_percent: 5
    deposit_min_amount: 2000
    deposit_max_amount: 20000
    refundable_window_minutes: 30
    refund_requires_evidence: true
  settlement_config:
    commission_rate_percent: 6
    commission_payer: SELLER
    rounding_mode: HALF_UP
    payout_requires_transfer_completed: true
    payout_mode: MANUAL
  listing_audit_config:
    listing_review_sla_hours: 24
    require_reject_reason: true
    duplicate_listing_policy: REJECT_AND_LOG
  customer_service_config:
    first_response_sla_minutes: 30
    conversation_retention_days: 365
```
### 第一部分：移动端（用户前台）功能明细

#### 1. 登录/注册与角色引导页

**入口与触发**

- 首页/我的页显式入口；收藏、咨询、下单、支付、发布等关键动作触发登录引导。
- 登录完成后支持回跳至来源页面（保留 `redirectUrl`），避免跳转错位。

**登录方式（P0）**

- **微信一键登录（小程序主路径）**：`wx.login` 获取 `code` → 后端换取 `token`。
- **短信验证码登录（H5/电脑端）**：短信发送 + 验证码校验；限流与频控必做。

**角色与认证引导（首次登录必经）**

- 角色选项：个人 / 企业 / 科研院校 / 政府 / 行业协会 / 技术经理人。
- **个人**默认自动通过；其他角色需提交认证资料并进入审核。
- 角色选择完成后，未审核通过用户仅可浏览与咨询，发布/支付需审核通过。

**表单与校验（最小集合）**

- 昵称长度 ≤ 50；手机号需脱敏展示；证件号/统一社会信用代码仅后台可见。
- 提交认证时必须校验必填字段与附件完整性；失败给出可操作提示。

**交互与文案**

- 登录页展示“登录即同意《用户协议》《隐私政策》”并提供链接。
- 身份选择页明确标注“企业/机构需审核，审核通过后可交易”。
- 授权手机号弹窗可跳过，但需提示“后续关键操作可能需要补绑”。

**安全与风控**

- 短信发送需图形验证码或设备风控校验，按用户与 IP 限流。
- 登录与身份选择动作记录审计日志（含来源与设备信息）。

```yaml
auth_onboarding:
  enable_wechat_login: true
  enable_sms_login_h5: true
  require_role_selection_after_login: true
  personal_auto_approve: true
  organization_requires_review: true
  redirect_after_login: back_to_source
```

#### 2. 首页 (Home)

**页面结构（P0 最小集合）**

- 顶部搜索入口（点击进入检索页）。
- Banner（单图或多图轮播，支持跳转链接）。
- 快捷入口区（5 个一排，固定：发明人榜 / 专利地图 / 书画专区 / 产学研需求 / 成果转化）。
- 特色专区（2×2 海报卡，支持专题跳转）。
- 推荐列表（默认推荐排序，卡片列表）。
- 公告条（最新 3 条，点击进入公告列表）。

**推荐与排序规则**

- 默认排序：推荐（综合点击/收藏/咨询/成交 + 区域产业标签权重）。
- 可在配置中调整权重与衰减策略（见 8.4 P0 参数配置）。

**权限与状态**

- 游客可浏览；收藏/咨询/下单/支付需登录且审核通过。
- 未登录时，关键按钮显示“登录解锁”提示并引导登录。

**数据接口（P0）**

- `GET /search/listings?sortBy=RECOMMENDED`：推荐列表。
- `GET /public/announcements`：公告条。
- `GET /public/organizations`：机构展示入口（可选）。

**空态与错误处理**

- 无数据展示 Empty 卡片，提供“去搜索/去发布”按钮。
- 接口失败展示错误卡片，可重试；不影响页面其他模块渲染。

## 附录：辅助页面（纳入交付范围）
- 通知中心（列表/详情）：系统与客服通知
- 设置页：通知设置、账号安全
- 法务/合规：隐私政策、服务条款、隐私指引
- 帮助与反馈：客服入口、FAQ
- 其它工具页：IPC 分类选择、产业集群选择

## 详情页实现规范（最佳实践）
- 专利/需求/成果详情统一为**单页滚动**结构，使用 **Sticky Tab** 作为锚点导航。
- 评论区与底部操作（收藏/咨询/订金）位于同页，不拆分多路由子页面。
